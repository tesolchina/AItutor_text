<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Tutor UI</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; }
        #transcript { width: 80%; height: 200px; margin: 20px auto; }
        #icons { font-size: 100px; margin: 20px auto; }
        #bottom-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; gap: 10px; }
        button { padding: 10px 20px; font-size: 16px; }
        
        /* Animations */
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes wiggle { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
        .animating-owl { animation: bounce 1s infinite; }
        .animating-ear { animation: wiggle 1s infinite; }
    </style>
</head>
<body>
    <h1>English Tutor Chat</h1>
    
    <div id="icons">
        <span id="earIcon" style="display: none;">ðŸ‘‚</span> <!-- Ear icon for user talking -->
        <span id="owlIcon" style="display: none;">ðŸ¦‰</span> <!-- Owl icon for tutor talking -->
    </div>
    
    <textarea id="transcript" readonly></textarea>
    
    <div id="bottom-controls">
        <button id="startBtn">Start Talking</button>
        <button id="stopSpeakingBtn" disabled>Stop Tutor Speaking</button>
    </div>
    
    <script>
        const startBtn = document.getElementById('startBtn');
        const stopSpeakingBtn = document.getElementById('stopSpeakingBtn');
        const transcriptArea = document.getElementById('transcript');
        const earIcon = document.getElementById('earIcon');
        const owlIcon = document.getElementById('owlIcon');
        
        let recognition;
        let isListening = false;
        
        // Initialize Web Speech Recognition (STT)
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
        } else {
            alert('Browser does not support speech recognition.');
        }
        
        startBtn.addEventListener('click', () => {
            if (!isListening) {
                recognition.start();
                startBtn.textContent = 'Stop Talking';
                isListening = true;
                earIcon.style.display = 'inline';
                earIcon.classList.add('animating-ear'); // Animate ear when listening
                owlIcon.style.display = 'none';
            } else {
                recognition.stop();
                startBtn.textContent = 'Start Talking';
                isListening = false;
                earIcon.style.display = 'none';
                earIcon.classList.remove('animating-ear');
            }
        });
        
        recognition.onresult = async (event) => {
            const userInput = event.results[0][0].transcript;
            transcriptArea.value += `You: ${userInput}\n`;
            const llmResponse = await getLLMResponse(userInput);
            transcriptArea.value += `Tutor: ${llmResponse}\n\n`;
            speakResponse(llmResponse); // TTS
        };
        
        recognition.onend = () => {
            isListening = false;
            startBtn.textContent = 'Start Talking';
            earIcon.style.display = 'none';
            earIcon.classList.remove('animating-ear');
        };
        
        // Function to call backend /chat endpoint
        async function getLLMResponse(input) {
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_input: input })
                });
                const data = await response.json();
                return data.response || data.error;
            } catch (error) {
                console.error(error);
                return 'Sorry, there was an error processing your request.';
            }
        }
        
        // TTS using browser SpeechSynthesis
        function speakResponse(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.voice = speechSynthesis.getVoices().find(voice => voice.name === 'Google US English');
            
            // Animate owl when speaking
            owlIcon.style.display = 'inline';
            owlIcon.classList.add('animating-owl');
            stopSpeakingBtn.disabled = false;
            
            utterance.onend = () => {
                owlIcon.style.display = 'none';
                owlIcon.classList.remove('animating-owl');
                stopSpeakingBtn.disabled = true;
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // Stop speaking button
        stopSpeakingBtn.addEventListener('click', () => {
            speechSynthesis.cancel();
            owlIcon.style.display = 'none';
            owlIcon.classList.remove('animating-owl');
            stopSpeakingBtn.disabled = true;
        });
    </script>
</body>
</html>